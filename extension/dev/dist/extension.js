"use strict";var B=Object.create;var l=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var M=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty;var F=(e,t)=>{for(var s in t)l(e,s,{get:t[s],enumerable:!0})},S=(e,t,s,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of L(t))!U.call(e,i)&&i!==s&&l(e,i,{get:()=>t[i],enumerable:!(n=R(t,i))||n.enumerable});return e};var p=(e,t,s)=>(s=e!=null?B(M(e)):{},S(t||!e||!e.__esModule?l(s,"default",{value:e,enumerable:!0}):s,e)),N=e=>S(l({},"__esModule",{value:!0}),e);var K={};F(K,{activate:()=>_,deactivate:()=>j});module.exports=N(K);var a=p(require("vscode"));var v=p(require("vscode")),A="agilityAI";function w(){let e=v.workspace.getConfiguration(A);return{apiBaseUrl:e.get("apiBaseUrl","http://localhost:8002").replace(/\/+$/,""),apiToken:e.get("apiToken",""),defaultTaskId:e.get("defaultTaskId",""),developerId:e.get("developerId",""),autoTrack:e.get("autoTrack",!0),languages:e.get("languages",[])}}function y(e){return v.workspace.onDidChangeConfiguration(t=>{t.affectsConfiguration(A)&&e(w())})}var h=class{settings;output;constructor(t,s){this.settings=t,this.output=s}updateSettings(t){this.settings=t}async sendSnapshot(t){let s=this.settings.apiBaseUrl;if(!s)throw new Error("Agility AI API base URL is not configured.");let n=`${s}/v1/snapshots`,i={"Content-Type":"application/json","User-Agent":"agility-ai-vscode-extension"};this.settings.apiToken&&(i.Authorization=`Bearer ${this.settings.apiToken}`);let o=await fetch(n,{method:"POST",headers:i,body:JSON.stringify({...t,source:"vscode-extension",sentAt:new Date().toISOString()})});if(!o.ok){let m=await o.text();throw new Error(`Failed to send snapshot: ${o.status} ${o.statusText} - ${m}`)}let g=await o.json().catch(()=>({}));return this.output.appendLine(`[Agility AI] Snapshot accepted for task ${t.taskId} (${t.filePath})`),g}};var d=p(require("vscode"));var I=require("child_process"),T=p(require("path")),b=p(require("vscode"));function x(e,t){return new Promise(s=>{let n=`git ${t.join(" ")}`;(0,I.exec)(n,{cwd:e,timeout:5e3},(i,o)=>{if(i){s(void 0);return}s(o.trim())})})}async function C(e){return b.workspace.getWorkspaceFolder(e.uri)?.uri.fsPath}async function E(e){return x(e,["rev-parse","--abbrev-ref","HEAD"])}async function P(e,t){let s=T.relative(e,t);return await x(e,["diff","--unified=3","--",s])}var k="agilityAI.currentTaskId",O="agilityAI.autoTrackEnabled",f=class{context;client;settings;output;statusItem;autoTrack;constructor(t,s,n,i){this.context=t,this.settings=s,this.client=n,this.output=i,this.autoTrack=this.context.workspaceState.get(O)??s.autoTrack,this.statusItem=d.window.createStatusBarItem("agilityAIStatus",d.StatusBarAlignment.Left,100),this.statusItem.command="agilityAI.toggleAutoTracking",this.refreshStatusBar(),this.statusItem.show()}updateSettings(t){this.settings=t,this.client.updateSettings(t),this.refreshStatusBar()}dispose(){this.statusItem.dispose()}getCurrentTaskId(){return this.context.workspaceState.get(k)||this.settings.defaultTaskId||void 0}async setCurrentTaskId(t){t?(await this.context.workspaceState.update(k,t.trim()),d.window.showInformationMessage(`Agility AI task set to ${t.trim()}`),this.output.appendLine(`[Agility AI] Active task set to ${t.trim()}`)):(await this.context.workspaceState.update(k,void 0),d.window.showInformationMessage("Agility AI task cleared."),this.output.appendLine("[Agility AI] Active task cleared")),this.refreshStatusBar()}isAutoTrackingEnabled(){return this.autoTrack}async toggleAutoTracking(){this.autoTrack=!this.autoTrack,await this.context.workspaceState.update(O,this.autoTrack),this.refreshStatusBar(),d.window.showInformationMessage(`Agility AI auto tracking ${this.autoTrack?"enabled":"disabled"}.`)}refreshStatusBar(){let t=this.getCurrentTaskId(),s=["Agility AI",this.autoTrack?"Auto: On":"Auto: Off",t?`Task: ${t}`:"Task: \u2014"];this.statusItem.text=s.join(" \u2022 "),this.statusItem.tooltip="Toggle auto tracking or set task via command palette (Agility AI)."}async handleDocumentSaved(t){if(!this.autoTrack||!this.settings.languages.includes(t.languageId))return;let s=this.getCurrentTaskId();if(!s){this.output.appendLine(`[Agility AI] Skipping snapshot for ${t.fileName} because no task is selected.`);return}let n=await this.buildSnapshotPayload(t,s);n&&await this.safeSendSnapshot(n)}async sendManualSnapshot(t){let s=this.getCurrentTaskId();if(!s)throw new Error('No task is selected. Run "Agility AI: Set Active Task" first.');let n=await this.buildSnapshotPayload(t,s);if(!n)throw new Error("Unable to generate snapshot payload.");await this.safeSendSnapshot(n)}async buildSnapshotPayload(t,s){let n=await C(t);if(!n){this.output.appendLine(`[Agility AI] Skipping ${t.fileName} because it is outside the workspace.`);return}let i=await E(n),o=await P(n,t.fileName);return{taskId:s,developerId:this.settings.developerId||void 0,languageId:t.languageId,filePath:t.fileName,content:t.getText(),diff:o||void 0,branch:i,metadata:{workspace:n,timestamp:new Date().toISOString()}}}async safeSendSnapshot(t){try{await this.client.sendSnapshot(t)}catch(s){let n=s instanceof Error?s.message:JSON.stringify(s);this.output.appendLine(`[Agility AI] ${n}`),d.window.showErrorMessage(`Agility AI snapshot failed: ${n}`,"Open Logs").then(i=>{i==="Open Logs"&&this.output.show(!0)})}}};var r;async function _(e){let t=a.window.createOutputChannel("Agility AI");e.subscriptions.push(t);let s=w(),n=new h(s,t);r=new f(e,s,n,t),e.subscriptions.push(r);let i=y(c=>{r?.updateSettings(c)});e.subscriptions.push(i);let o=a.workspace.onDidSaveTextDocument(async c=>{await r?.handleDocumentSaved(c)});e.subscriptions.push(o);let g=a.commands.registerCommand("agilityAI.setActiveTask",async()=>{let c=r?.getCurrentTaskId(),u=await a.window.showInputBox({title:"Agility AI: Active Task",value:c,placeHolder:"Enter the task ID the current work belongs to",prompt:"Provide the Agility task ID (leave blank to clear)."});u!==void 0&&await r?.setCurrentTaskId(u.length>0?u:void 0)});e.subscriptions.push(g);let m=a.commands.registerCommand("agilityAI.sendSnapshot",async()=>{let c=a.window.activeTextEditor;if(!c){a.window.showWarningMessage("Open a file in the editor before sending a snapshot.");return}try{await r?.sendManualSnapshot(c.document),a.window.showInformationMessage("Agility AI snapshot sent successfully.")}catch(u){let $=u instanceof Error?u.message:String(u);a.window.showErrorMessage(`Agility AI snapshot failed: ${$}`)}});e.subscriptions.push(m);let D=a.commands.registerCommand("agilityAI.toggleAutoTracking",async()=>{await r?.toggleAutoTracking()});e.subscriptions.push(D),t.appendLine("[Agility AI] Extension activated.")}function j(){r?.dispose(),r=void 0}0&&(module.exports={activate,deactivate});
